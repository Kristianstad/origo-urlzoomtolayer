name: Build and Compress Assets

on:
  workflow_dispatch:  # Manuellt triggad via GitHub UI
  push:               # Automatiskt triggad vid commit
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Build/minify JS and CSS
        run: |
          # Försök köra eventuell befintlig build-script
          if npm run build --silent; then
            echo "Körde npm run build"
          else
            echo "Ingen build-script, minifierar manuellt"
            npm install -g terser clean-css-cli brotli-cli
            
            # Minifiera alla .js (exkluderar redan minifierade och node_modules)
            find . -name "*.js" -not -path "./node_modules/*" -not -name "*.min.js" -exec bash -c '
              file="$0"
              minfile="${file%.js}.min.js"
              echo "Minifierar $file → $minfile"
              terser "$file" -c -m -o "$minfile"
            ' {} \;
            
            # Minifiera alla .css
            find . -name "*.css" -not -path "./node_modules/*" -not -name "*.min.css" -exec bash -c '
              file="$0"
              minfile="${file%.css}.min.css"
              echo "Minifierar $file → $minfile"
              cleancss -o "$minfile" "$file"
            ' {} \;
          fi

      - name: Komprimera med gzip och brotli
        run: |
          # Komprimera alla minifierade filer
          find . \( -name "*.min.js" -o -name "*.min.css" \) -exec bash -c '
            file="$0"
            echo "Komprimerar $file"
            gzip -9 -c "$file" > "$file.gz"
            brotli --best -f "$file" -o "$file.br"
          ' {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: urlzoomtolayer-compressed-assets
          path: |
            **/*.min.js
            **/*.min.css
            **/*.min.js.gz
            **/*.min.css.gz
            **/*.min.js.br
            **/*.min.css.br
          retention-days: 90
